# Отчёт по Лабораторной работе №2: Трекинг объекта на основе ключевых точек

## 1. Теоретическая база

### Ключевые точки и дескрипторы
Для отслеживания объекта используется метод сопоставления особенностей (feature matching). Особенности — это уникальные участки изображения (углы, края, пятна), которые можно надежно найти на разных кадрах, даже если изменился масштаб, поворот или освещение.

В данной работе используется алгоритм **SIFT (Scale-Invariant Feature Transform)**. 
- **Инвариантность**: SIFT устойчив к изменению масштаба и вращению изображения.
- **Дескрипторы**: Для каждой найденной ключевой точки вычисляется дескриптор — вектор чисел, описывающий окрестность точки. Это позволяет находить соответствия между точками на разных изображениях.

### Сопоставление (Matching)
Для нахождения пар соответствующих точек между эталонным изображением (первый кадр) и текущим кадром используется **FLANN (Fast Library for Approximate Nearest Neighbors)**. Это быстрый алгоритм поиска ближайших соседей, который эффективнее полного перебора для многомерных пространств (размерность дескриптора SIFT — 128).

### Фильтрация совпадений
Не все найденные совпадения верны. Используется **Lowe's ratio test**: совпадение считается хорошим, если расстояние до ближайшего соседа значительно меньше расстояния до второго по близости соседа (коэффициент 0.7). Это отсеивает ложные срабатывания, возникающие из-за повторяющихся текстур.

### Гомография
После нахождения набора соответствующих точек необходимо определить геометрическое преобразование, которое переводит точки объекта с эталонного кадра в координаты текущего кадра. Для этого вычисляется матрица гомографии (3x3) с использованием алгоритма **RANSAC**, который устойчив к выбросам (неверным совпадениям).

## 2. Описание разработанной системы

### Архитектура
Программа написана на языке Python с использованием библиотеки OpenCV.

Основные этапы работы алгоритма:
1. **Инициализация**: Загрузка видео и детектора SIFT.
2. **Обработка эталона**: 
   - Считывается первый кадр видео.
   - На нем находятся ключевые точки и дескрипторы.
   - Запоминаются размеры изображения (углы прямоугольника), которые будут использоваться для отрисовки рамки.
3. **Цикл обработки кадров**:
   - Для каждого следующего кадра находятся ключевые точки и дескрипторы.
   - Производится сопоставление дескрипторов текущего кадра с дескрипторами эталона (FLANN).
   - Фильтрация совпадений (Lowe's ratio test).
   - Если найдено достаточное количество хороших совпадений (>10):
     - Вычисляется матрица гомографии.
     - Координаты углов эталона трансформируются с помощью матрицы гомографии в координаты текущего кадра.
     - Отрисовывается многоугольник (рамка) вокруг найденного объекта.
   - Результат записывается в выходной видеофайл.

### Использование
Запуск программы:
```bash
python tracker.py <путь_к_видео> <путь_к_результату>
```

Пример:
```bash
python tracker.py test-videos/mona-lisa.avi outputs/mona-lisa_tracked.avi
```

## 3. Результаты работы и тестирования системы

Система была протестирована на следующих видеофайлах:

> При наклоне камеры - детекция работает хуже, в результате чего рамка объекта `скачет` 

1. **mona-lisa.avi**: 
   - Объект (портрет) успешно отслеживается при перемещении и вращении.
   - SIFT корректно находит соответствующие точки на текстуре картины.
   - Сбоит при наклоне

2. **mona-lisa-blur.avi** (с размытием) и **mona-lisa-blur-extra-credit.avi**:
   - Благодаря устойчивости SIFT, трекинг продолжает работать даже при некотором размытии изображения, хотя количество найденных точек может уменьшаться.
   - Сбоит при наклоне

3. **my.avi**
   - Объект (коврик для мыши) успешно отслеживается при перемещении и вращении.
   - Сбоит при наклоне

*(Результаты работы сохранены в папке `outputs`)*

## 4. Выводы по работе

В ходе работы был реализован и протестирован алгоритм трекинга объектов на основе ключевых точек SIFT.

**Преимущества подхода**:
- Устойчивость к изменению масштаба (приближение/удаление объекта).
- Устойчивость к вращению (как в плоскости кадра, так и небольшие перспективные искажения).
- Способность работать при частичном перекрытии, если видно достаточное количество текстурных особенностей.

**Недостатки**:
- Алгоритм требователен к вычислительным ресурсам (SIFT медленнее, чем ORB или методы на основе корреляции/оптического потока).
- Плохо работает на объектах без выраженной текстуры (однотонные предметы).
- Может давать сбои при сильном размытии (motion blur) и наклоне камеры.


## 5. Использованные источники

1. Документация OpenCV: [Feature Matching + Homography to find Objects](https://docs.opencv.org/4.x/d1/de0/tutorial_py_feature_homography.html)
2. D.G. Lowe, "Distinctive Image Features from Scale-Invariant Keypoints", International Journal of Computer Vision, 2004.


